<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Example</title>

    <style type="text/css">


    </style>
</head>
<body>

    <h2>PHPi WebSocket</h2>

    <table>
        <tr>
            <td>Status:</td>
            <td id="list-status"></td>
        </tr>
        <tr>
            <td>Time on Pi:</td>
            <td id="list-time"></td>
        </tr>
    </table>





</body>

<script type="text/javascript">


    /** Credit Ismael Celis - https://gist.github.com/ismasan/299789 **/
    var ServerEventsDispatcher = function(url){
        var conn = new WebSocket(url);

        var callbacks = {};

        this.bind = function(event_name, callback){
            callbacks[event_name] = callbacks[event_name] || [];
            callbacks[event_name].push(callback);
            return this;
        };

        this.send = function(event_name, event_data){
            var payload = JSON.stringify({event:event_name, data: event_data});
            conn.send(payload);
            return this;
        };

        // dispatch to the right handlers
        conn.onmessage = function(evt){
            var json = JSON.parse(evt.data);
            dispatch(json.event, json.data);
        };

        conn.onclose = function(){ dispatch('close', null)};
        conn.onopen = function(){ dispatch('open', null)};

        var dispatch = function(event_name, message){
            var chain = callbacks[event_name];
            if(typeof chain == 'undefined') return; // no callbacks for this event
            for(var i = 0; i < chain.length; i++){
                chain[i](message)
            }
        }
    };


    var socket = new ServerEventsDispatcher('ws://raspberrypi.local:9999/phpi');

    socket.bind('open', function(){
        document.getElementById('list-status').innerHTML = 'Connected';

    }).bind('close', function(){
        document.getElementById('list-status').innerHTML = 'Disconnected';
        //could do something here like try to reconnect

    }).bind('time', function(message){
        document.getElementById('list-time').innerHTML = message;

    }).bind('header.update', function(message){
        console.log(message);

    });


</script>

</html>

